(function (tinymce, $) {
  "use strict";

  var Tag_username = function (editor, options) {
    this.editor = editor;
    this.options = options;
    this.query_keyword = "";
    this.currentRange = null;

    this.renderPanel();
    this.addEvents();
  };

  Tag_username.prototype = {
    selector_panel: null,
    timer_input: null,

    renderPanel: function () {
      var id = "mce-panel-tag-username";
      if ($("#" + id).length === 0) {
        this.selector_panel = $(
          '<ul id="' + id + '" class="search-user__results"></ul>'
        );
        this.selector_panel.hide();
        $("body").append(this.selector_panel);
      } else {
        this.selector_panel = $("#" + id);
      }
      this.selector_panel.hide();
    },

    delay_input: function (callback, ms) {
      clearTimeout(this.timer_input);
      this.timer_input = setTimeout(callback, ms);
    },

    updateQuery: function () {
      var sel = this.editor.selection;
      var rng = sel.getRng();
      this.currentRange = rng.cloneRange();

      var container = rng.startContainer;
      var offset = rng.startOffset;

      if (container.nodeType !== 3) return this.clear(); // chỉ xử lý text node

      var text = container.textContent.substring(0, offset);
      var atIndex = text.lastIndexOf(this.options.delimiter);
      if (atIndex === -1) {
        return this.clear();
      }

      // Nếu gõ space → huỷ panel
      if (text[offset - 1] === " ") {
        return this.clear();
      }

      this.query_keyword = text.substring(atIndex + 1).replace(/\s/g, "");
      if (!this.query_keyword.length) {
        this.clear();
        return;
      }

      this.showPanelAtCaret(rng);
      this.fetchUsers();
    },

    normalizeCaret: function () {
      var sel = this.editor.selection;
      var rng = sel.getRng();
      var container = rng.startContainer;

      // Nếu container là text node
      if (container.nodeType === 3) {
        // kiểm tra parent có phải span tag không
        if (
          container.parentNode &&
          container.parentNode.classList.contains("mce-tag-username")
        ) {
          // thay span bằng text node
          var span = container.parentNode;
          var textNode = document.createTextNode(span.textContent);
          span.parentNode.replaceChild(textNode, span);

          var newRange = document.createRange();
          newRange.setStart(textNode, textNode.length);
          newRange.collapse(true);
          sel.setRng(newRange);
          this.currentRange = newRange.cloneRange();
          return true;
        }

        // kiểm tra sibling bên trái có phải span tag không
        if (
          container.previousSibling &&
          container.previousSibling.classList &&
          container.previousSibling.classList.contains("mce-tag-username")
        ) {
          var prevSpan = container.previousSibling;
          var textNode = document.createTextNode(prevSpan.textContent);
          prevSpan.parentNode.replaceChild(textNode, prevSpan);

          var newRange = document.createRange();
          newRange.setStart(container, 0);
          newRange.collapse(true);
          sel.setRng(newRange);
          this.currentRange = newRange.cloneRange();
          return true;
        }
      }

      return false;
    },

    showPanelAtCaret: function (rng) {
      var rect;
      if (rng.getClientRects().length) {
        rect = rng.getClientRects()[0];
      } else {
        var span = document.createElement("span");
        span.innerHTML = "\uFEFF";
        rng.insertNode(span);
        rect = span.getBoundingClientRect();
        span.parentNode.removeChild(span);
      }

      // Lấy tọa độ iframe TinyMCE
      var iframe = $(this.editor.getContentAreaContainer()).find("iframe")[0];
      var iframeRect = iframe.getBoundingClientRect();

      this.selector_panel.css({
        left: rect.left + iframeRect.left + window.scrollX + "px",
        top: rect.bottom + iframeRect.top + window.scrollY + 4 + "px",
        position: "absolute",
        display: "block",
        zIndex: 99999,
      });
    },

    fetchUsers: function () {
      var self = this;
      if (!this.query_keyword.length) return;

      fetch(this.options.api_url, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ keyword: this.query_keyword }),
      })
        .then((res) => res.json())
        .then((data) => {
          const users = data.data || [];
          if (!users.length) {
            this.normalizeCaret();
            return this.clear();
          }

          this.selector_panel.show();
          const html = users
            .map(
              (u) =>
                `<li class="search-user__results-item" data-id="${u.id}" data-name="${u.name}" data-username="${u.username}">
                  <div class="user-infomation bg--none">
                    <div class="user-avatar" data-text="${u.first_name}" style="--bg-avatar: ${u.bg_avatar}">
                      <img src="${u.avatar}">
                    </div>
                    <div>
                      <div class="user-display-name">${u.display_name}</div>
                      <div class="user-username">@${u.username}</div>
                    </div>
                  </div>
                </li>`
            )
            .join("");
          self.selector_panel.html(html);

          self.selector_panel
            .find(".search-user__results-item")
            .off()
            .on("click", function (e) {
              var target = $(e.currentTarget);
              self.insertUsername(
                target.data("name") || target.data("username"),
                target.data("id")
              );
            });
        })
        .catch((err) => {
          this.selector_panel.hide();
        });
    },

    insertUsername: function (name, id) {
      if (!this.currentRange) return;

      var sel = this.editor.selection;
      sel.setRng(this.currentRange);

      var rng = sel.getRng();
      var container = rng.startContainer;
      var offset = rng.startOffset;

      var text = container.textContent;
      var atIndex = text.lastIndexOf(this.options.delimiter, offset);
      if (atIndex === -1) return;

      var before = text.slice(0, atIndex);
      var after = text.slice(offset);
      var parent = container.parentNode;

      var beforeNode = document.createTextNode(before);
      var afterNode = document.createTextNode(after);

      // span username
      var span = document.createElement("span");
      span.className = "mce-tag-username";
      span.dataset.id = id;
      span.textContent = "@" + name;

      // span tách caret
      var sep = document.createElement("span");
      sep.className = "tag-separator";
      sep.innerHTML = "&nbsp;";

      parent.insertBefore(beforeNode, container);
      parent.insertBefore(span, container);
      parent.insertBefore(sep, container);
      parent.insertBefore(afterNode, container);
      parent.removeChild(container);

      // đặt caret vào span tách
      var newRng = document.createRange();
      newRng.setStart(sep, 1);
      newRng.collapse(true);
      sel.setRng(newRng);

      this.clear();
    },
    addEvents: function () {
      var self = this;

      this.editor.on("keydown", function (e) {
        if (e.key === "Backspace") {
          var sel = self.editor.selection;
          var rng = sel.getRng();
          var container = rng.startContainer;
          var offset = rng.startOffset;

          if (container.nodeType === 3 && offset > 0) {
            var prevChar = container.textContent[offset - 1]; // ký tự sắp bị xoá
            if (prevChar !== " ") {
              self.normalizeCaret();
              self.clear();
            }
          }
        }
      });

      this.editor.on("keyup input", function (e) {
        var sel = self.editor.selection;
        var rng = sel.getRng();
        if (!rng) return self.clear();

        var container = rng.startContainer;
        var offset = rng.startOffset;

        var text = "";
        if (container.nodeType === 3) {
          text = container.textContent.substring(0, offset);
        } else {
          text = container.textContent || "";
        }

        var atIndex = text.lastIndexOf(self.options.delimiter);

        // Nếu text rỗng, không còn @, hoặc gõ space → clear panel ngay (không AJAX)
        if (!text || atIndex === -1 || e.key === " ") {
          self.clear();
          return;
        }

        // Lấy query sau @
        var query = text.substring(atIndex + 1);
        var USERNAME_REGEX = /^(?![_.])(?!.*[_.]{2})[a-zA-Z0-9._]+(?<![_.])$/;

        // Nếu query không hợp lệ → clear panel ngay
        if (!USERNAME_REGEX.test(query)) {
          self.clear();
          return;
        }

        // Chỉ gọi AJAX khi gõ ký tự bình thường, debounce
        if (e.key && e.key.length === 1) {
          self.delay_input(function () {
            self.updateQuery();
          }, 350);
        }
      });

      // chỉ ẩn panel khi click ra ngoài panel
      $(document).on("click.taguser", function (e) {
        if (!$(e.target).closest("#mce-panel-tag-username").length) {
          self.clear();
        }
      });
    },

    clear: function () {
      this.query_keyword = "";
      this.currentRange = null;
      if (this.selector_panel) this.selector_panel.hide();
    },
  };

  tinymce.create("tinymce.plugins.taguser", {
    init: function (editor) {
      var options = editor.getParam("plugin_taguser") || {};
      if (!options.api_url || !options.delimiter) return;
      new Tag_username(editor, options);
    },
    getInfo: function () {
      return {
        longname: "Tag Username",
        author: "InuHa",
        version: tinymce.majorVersion + "." + tinymce.minorVersion,
      };
    },
  });

  tinymce.PluginManager.add("taguser", tinymce.plugins.taguser);
})(tinymce, jQuery);
